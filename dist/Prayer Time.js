// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: deep-green; icon-glyph: mosque;
const t={widget:{settings:{file:"Prayer Time",directory:"Prayer Time",size:"small",offline:3},display:{prayerTimes:[{name:"fajr",display:"ðŸŒ„"},{name:"sunrise",display:"ðŸŒ…"},{name:"dhuhr",display:"ðŸž"},{name:"asr",display:"ðŸ™"},{name:"maghrib",display:"ðŸŒ‡"},{name:"isha",display:"ðŸŒƒ"},{name:"sunset",display:"ðŸŒ…"}]}},api:{endpoint:"http://api.aladhan.com/v1/timings/",location:{latitude:0,longitude:0}}};function e(t,e){const n=t.addStack();return n.spacing=e,n.centerAlignContent(),n}function n(t,e){const n=t.addStack();n.addSpacer();const i=n.addText(e);return i.lineLimit=1,n.addSpacer(),i}async function i(t){const e=new Request(t);return await e.loadJSON()}function a(t,e,n){const i=function(t){const e=t||new Date;return new Date(e).toLocaleString(void 0,{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"-")}(e),a=function(t,e){let n=t.includes("?");for(const i in e)if(e.hasOwnProperty(i)){const a=e[i];null!=a&&(t+=(n?"&":"?")+encodeURIComponent(i)+"="+encodeURIComponent(a.toString()),n=!0)}return t}(`${t}${i}`,n);return encodeURI(a)}function o(t){const[e,n,i]=t.split("-"),a=new Date(Number(i),Number(n)-1,Number(e));return a.setHours(0,0,0,0),a}function r(t){const e=`${t.widget.settings.file}.json`,n=t.widget.settings.directory,i=FileManager.iCloud(),a=i.joinPath(i.documentsDirectory(),n);return i.fileExists(a)||i.createDirectory(a),i.joinPath(a,e)}async function s(t){let e=FileManager.iCloud(),n=r(t);if(e.fileExists(n)){e.isFileDownloaded(n)||await e.downloadFileFromiCloud(n);const t=e.readString(n);return JSON.parse(t)}return[]}(async()=>{await async function(t){try{const e=await Location.current();t.api.location.latitude=e.latitude,t.api.location.longitude=e.longitude,console.log([e,t.api.location])}catch(t){console.error(t)}}(t),await async function(){if(await async function(){const t=15,e=new Request("https://www.google.com");e.method="HEAD",e.timeoutInterval=t/60;try{return!!await e.load()}catch(t){return!1}}()){const e=await async function(t){const{api:{endpoint:e,method:n,location:{latitude:o,longitude:r}},widget:{settings:{offline:s}}}=t,c=[];for(let t=0;t<s;t++){const s=new Date;s.setDate(s.getDate()+t);const d=a(e,s,{latitude:o,longitude:r,method:n}),l=(await i(d)).data;c.push(l)}return c}(t);await async function(t,e){const n=e,i=await s(t),a=[];(function(t){const e=[];return t.forEach((t=>{e.some((e=>JSON.stringify(e)===JSON.stringify(t)))||e.push(t)})),e})(i).filter((({date:{gregorian:{date:e}}})=>{const n=new Date;n.setHours(0,0,0,0);const i=new Date(n);i.setDate(n.getDate()+t.widget.settings.offline);const a=o(e)>=n,r=o(e)<=i;return a&&r})),n.forEach((t=>{if(!1===a.some((e=>JSON.stringify(e)===JSON.stringify(t)))){const e=a.findIndex((({date:{gregorian:{date:e}}})=>t.date.gregorian.date===e));e>=0&&(a[e]=t),-1===e&&a.push(t)}})),a.sort(((t,e)=>{const n=new Date(t.date.gregorian.date),i=new Date(e.date.gregorian.date);return n<i?-1:n>i?1:0})),function(t,e){let n=FileManager.iCloud(),i=r(t),a=JSON.stringify(e,null,2);n.writeString(i,a)}(t,a)}(t,e)}const c=await s(t);c&&function(i,a){const{widget:{display:{prayerTimes:o}}}=a,r=2,s=new Date,c=o.map((t=>t.name.toUpperCase()));!function(i){const a=6,o=new ListWidget,r=o.addStack();r.layoutVertically(),r.centerAlignContent();let s=e(r,a);i.forEach(((i,o)=>{const{prayer:c,time:d}=i,l=t.widget.display.prayerTimes.find((t=>t.name.toLowerCase()===c.toLowerCase()));if(l){const t=function(t,e={hour:"numeric",minute:"numeric",hour12:!0}){return t.toLocaleTimeString(void 0,e).toUpperCase()}(d);!function(t,e,i,a){const o=t.addStack();o.spacing=2,o.layoutVertically(),o.centerAlignContent();n(o,e).font=new Font("AvenirNext-Bold",16);const r=n(o,i);r.font=new Font("AvenirNext-Regular",16);const s=n(o,a);s.font=new Font("AvenirNext-Medium",16)}(s,c,l.display,t),s=e(r,a)}})),o.presentSmall()}(i.map((t=>function(t){const{timings:e,date:{gregorian:n}}=t,i=n.date.split("-"),a=`${i[2]}-${i[1]}-${i[0]}`;return Object.entries(e).map((([t,e])=>{const n=e.split(":");return{prayer:t,time:new Date(`${a}T${n[0]}:${n[1]}:00`)}}))}(t))).flat().filter((t=>c.includes(t.prayer.toUpperCase()))).filter((t=>t.time>s)).sort(((t,e)=>t.time.getTime()-e.time.getTime())).slice(0,r))}(c,t)}()})();
