// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: deep-green; icon-glyph: mosque;
async function t(t){let e=FileManager.iCloud();if(e.fileExists(t)){e.isFileDownloaded(t)||await e.downloadFileFromiCloud(t);const n=e.readString(t);return JSON.parse(n)}return[]}function e(t,e,n){const i=function(t,e){let n=t.includes("?");for(const a in e)if(e.hasOwnProperty(a)){const i=e[a];null!=i&&(t+=(n?"&":"?")+encodeURIComponent(a)+"="+encodeURIComponent(i.toString()),n=!0)}return t}(`${t}${a(e)}`,n);return encodeURI(i)}function n(t){const[e,n,a]=t.split("-"),i=new Date(Number(a),Number(n)-1,Number(e));return i.setHours(0,0,0,0),i}function a(t){const e=t||new Date;return new Date(e).toLocaleString(void 0,{day:"2-digit",month:"2-digit",year:"numeric"}).replace(/\//g,"-")}function i(t,e={hour:"numeric",minute:"numeric",hour12:!0}){return t.toLocaleTimeString(void 0,e).toUpperCase()}async function o(t){const e=new Request(t);return await e.loadJSON()}async function r(e,a,i){const o=i,r=await t(e),s=[];(function(t){const e=[];return t.forEach((t=>{e.some((e=>JSON.stringify(e)===JSON.stringify(t)))||e.push(t)})),e})(r).filter((({date:{gregorian:{date:t}}})=>{const e=new Date;e.setHours(0,0,0,0);const i=new Date(e);i.setDate(e.getDate()+a);const o=n(t)>=e,r=n(t)<=i;return o&&r})),o.forEach((t=>{if(!1===s.some((e=>JSON.stringify(e)===JSON.stringify(t)))){const e=s.findIndex((({date:{gregorian:{date:e}}})=>t.date.gregorian.date===e));e>=0&&(s[e]=t),-1===e&&s.push(t)}})),s.sort(((t,e)=>{const n=new Date(t.date.gregorian.date),a=new Date(e.date.gregorian.date);return n<a?-1:n>a?1:0})),function(t,e){let n=FileManager.iCloud(),a=JSON.stringify(e,null,2);n.writeString(t,a)}(e,s)}function s(t,e,n){const a=new Date,i=e.map((t=>t.name.toUpperCase()));let o=t.map((t=>function(t){const{timings:e,date:{gregorian:n}}=t,a=n.date.split("-"),i=`${a[2]}-${a[1]}-${a[0]}`;return Object.entries(e).map((([t,e])=>{const n=e.split(":");return{prayer:t,dateTime:new Date(`${i}T${n[0]}:${n[1]}:00`)}}))}(t))).flat().filter((t=>i.includes(t.prayer.toUpperCase()))).filter((t=>t.dateTime>a)).sort(((t,e)=>t.dateTime.getTime()-e.dateTime.getTime()));return n&&(o=o.slice(0,n)),o}function c(t,e,n,o,r){const c=function(t){const e=new Date,n=new Date(new Date(e).setHours(0,0,0,0)),a=new Date(n.getTime()+864e5-1),i=t.findIndex((t=>t.dateTime>e));return t.map(((t,n)=>{let o="unknown",r=!1;return o=t.dateTime<e?"past":t.dateTime>e&&t.dateTime<=a?"today":"future",n===i&&(r=!0),{prayer:t.prayer,dateTime:t.dateTime,status:{state:o,next:r}}}))}(s(t,e,n)),d=new Date,u="#FFFFFF",g=new ListWidget;"accessoryCircular"!==o&&(g.setPadding(16,20,16,20),g.spacing=4);const m=g.addStack();if(m.layoutVertically(),m.centerAlignContent(),m.spacing=4,c.forEach((t=>{const{prayer:n,dateTime:a}=t,r=function(t,e){const n=new Date(t),a=(new Date(e).getTime()-n.getTime())/864e5;return Math.abs(a)}(d,a)+1,s=new Color(u,.8/r),c=e.find((t=>t.name.toLowerCase()===n.toLowerCase()));if(c){const{name:e,abbreviation:n}=c,a="medium"===o||"large"===o?e.toUpperCase():n;!function(t,e,n,a,o,r){const{dateTime:s,status:c}=n,l=i(s),d=14;let u,g=new Font("AvenirNext-Regular",12);c&&"future"===c.state&&(u=r);c&&c.next&&(g=new Font("AvenirNext-Bold",d));const m=t.addStack();m.spacing=a,m.centerAlignContent(),"accessoryCircular"===o&&m.layoutVertically();const f=m.addText(e);f.font=g,f.lineLimit=1,"accessoryCircular"!==o&&m.addSpacer(void 0);let p=l;const w=m.addText(p);w.font=g,w.lineLimit=1,"accessoryCircular"===o&&(f.centerAlignText(),w.centerAlignText(),w.minimumScaleFactor=.5,m.backgroundColor=new Color("#000000"));u&&(f.textColor=u,w.textColor=u)}(m,a,t,4,o,s)}})),"accessoryCircular"!==o){const t=g.addStack();t.layoutVertically();const e=l(t,`${r} metres`);e.font=new Font("AvenirNext-Regular",10),e.textColor=new Color(u,.8);const n=l(t,`${a(d)} ${i(d)}`);n.font=new Font("AvenirNext-Regular",10),n.textColor=new Color(u,.8)}return g}function l(t,e){const n=t.addStack();n.addSpacer();const a=n.addText(e);return a.lineLimit=1,n.addSpacer(),a}const d={widget:{settings:{file:"Prayer Time",directory:"Prayer Time",size:"small",offline:5},display:{prayerTimes:[{name:"fajr",display:"ðŸŒ„",abbreviation:"FAJ"},{name:"dhuhr",display:"ðŸ•›",abbreviation:"DHU"},{name:"asr",display:"ðŸŒž",abbreviation:"ASR"},{name:"maghrib",display:"ðŸŒ†",abbreviation:"MAG"},{name:"isha",display:"ðŸŒ™",abbreviation:"ISH"},{name:"imsak",display:"â­",abbreviation:"IMS"}]}},api:{endpoint:"https://api.aladhan.com/v1/timings/",location:{latitude:0,longitude:0}}};(async()=>{try{await async function(){const{widget:{settings:{directory:a,file:i,offline:l},display:{prayerTimes:u}},api:{location:g}}=d,m=1e3,f=config.widgetFamily?config.widgetFamily:"small";let p=5;"large"===f&&(p=14);"accessoryCircular"!==f&&"accessoryInline"!==f&&"accessoryRectangular"!==f||(p=1);const w=function(t,e){const n=`${t}.json`,a=e,i=FileManager.iCloud(),o=i.joinPath(i.documentsDirectory(),a);return i.fileExists(o)||i.createDirectory(o),i.joinPath(o,n)}(i,a),y=await async function(){const t=new Request("https://www.google.com");t.method="HEAD",t.timeoutInterval=.25;try{return!!await t.load()}catch(t){return!1}}();let h=0;if(y){const a=new Date,i=await t(w),c=function(t,e){const a=t.filter((({date:{gregorian:{date:t}}})=>{const a=e||new Date;a.setHours(0,0,0,0);const i=n(t);return a.toDateString()===i.toDateString()}));if(a[0])return a[0]}(i,a),f=s(i,u).length,{latitude:y,longitude:D}=await async function(t){return await Location.current()}();if(d.api.location.latitude=y,d.api.location.longitude=D,c){const{meta:t}=c,e=function(t,e){const n=t=>t*(Math.PI/180),a=n(e.latitude-t.latitude),i=n(e.longitude-t.longitude),o=Math.sin(a/2)*Math.sin(a/2)+Math.cos(n(t.latitude))*Math.cos(n(e.latitude))*Math.sin(i/2)*Math.sin(i/2);return 2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o))*6371*1e3}(g,t);h=Math.round(100*(e+Number.EPSILON))/100}if(g&&(f<=p||h>m)){const t=await async function(t){const{api:{endpoint:n,method:a,location:{latitude:i,longitude:r}},widget:{settings:{offline:s}}}=t,c=[];for(let t=0;t<s;t++){const s=new Date;s.setDate(s.getDate()+t);const l=e(n,s,{latitude:i,longitude:r,method:a}),d=(await o(l)).data;c.push(d)}return c}(d);await r(w,l,t)}}const D=await t(w);if(D){const t=c(D,u,p,f,h);config.runsInAccessoryWidget?Script.setWidget(t):t.presentLarge()}Script.complete()}()}catch(t){console.error(t)}})();
